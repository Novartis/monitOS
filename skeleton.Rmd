---
title: "monitOS"
author: "Thibaud Coroller"
output:
  html_document:
    toc: true
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
# replace rhs with package name
PACKAGE <- "monitOS"

## Do NOT modify this section.
knitr::opts_chunk$set(echo = FALSE)
library(xfun)
library(covr)
loaded <- require(PACKAGE, character.only = TRUE)
failWhenIncomplete <- FALSE

incompleteFun <- if (failWhenIncomplete) stop else warning
```

<!-- Hint: Search '$' to find all fields that need to be filled out. -->

# Package Description {#description}

The below table provides an overview of the foreseen scope and intent of the package
as well as details w.r.t. ownership:

```{r details, echo=FALSE}
# the full title of the package
title <- "monitOS" 

# the names of the main package developers
devs <- "Thibaud Coroller"
# the url of the package repo
repo <- "https://github.com/Novartis/monitOS"

# the url of the package reference page (e.g., created with {pkgdown})
refs <- "https://opensource.nibr.com/monitOS/"

# provide a high-level description of the package
# this should include examples of use cases: how is this package foreseen to be
# used by other associates
highlevelDescription <- "These guidelines are meant to provide a pragmatic, yet rigorous, help to drug developers and decision makers, since they are shaped by three fundamental ingredients: the clinically determined margin of detriment on OS that is unacceptably high (δnull); the benefit on OS that is plausible given the mechanism of action of the novel intervention (δalt); and the quantity of information (i.e. events, expected number of survival events, at primary and final analysis) it is feasible to accrue given the clinical and drug development setting. The proposed guidelines facilitate transparent discussions between stakeholders focusing on the risks of erroneous decisions and what might be an acceptable trade-off between power and the false positive error rate."
```

<!-- Do NOT modify this section. -->
```{r details_output, echo=FALSE}
description <- data.frame(field=c("Package Title", "Main developer(s)",
                                  "Source Code Location", "Package Page", "Package Description"),
                          values = c(title, devs, repo, refs, highlevelDescription))
descripionTable <- knitr::kable(description, col.names = NULL)

# escape dollar signs that might still be lingering
# intToUtf8(36) is the dollar sign (so it doesn't show up in the search)
gsub(paste0("\\",intToUtf8(36)), paste0("\\\\",intToUtf8(36)), descripionTable)
```
<!-- --------------------------- -->

## DESCRIPTION

<!-- Do NOT modify this section. -->
The below output represents the package's DESCRIPTION file, which is visible to all users of the package. 
Its details must be consistent with the high-level description given above.

```{r DESCRIPTION, echo=FALSE}
if (loaded) {
  packageDescription(PACKAGE)
} else {
  incompleteFun("Package could not be loaded.")
}

```
<!-- --------------------------- -->

# Requirements {#requirements}

Requirements are to be created to formally define the scope
and function of the package. 
They clarify how the package is to be used and how the package should behave
when it is working as intended. Requirements should be written from a user's perspective 
and give insight into potential contexts of use.

<!-- $ Please populate this section with requirements.
Example (requirements as table):

|ID | Requirement |
|:---|:-------------|
Req-1 | The package should correctly compute the dose limiting toxicity (DLT) as a function of dose of two drugs given historical information on the toxicity profiles from single agent trials as per the methodology outlined in XY. |
Req-2 | ... |

---

Example (requirements as subheadings):

## Requirement 1: Dual combination trial with historical information
The package should correctly compute the dose limiting toxicity as a function of dose of two drugs given historical information on the toxicity profiles from single agent trials as per the methodology outlined in XY.

## Requirement 2: ...

-->

## Vignettes

<!-- Do NOT modify this section. -->
The below output lists the package's vignettes, which are visible to all users of the package. 
The content of these vignettes must be consistent with the overall package requirements.

```{r vignettes, echo=FALSE}
if (loaded) {
  knitr::kable(as.data.frame(tools::getVignetteInfo(PACKAGE))[,c("Title", "Topic")])  
} else {
  incompleteFun("Package could not be loaded.")
}
```
<!-- --------------------------- -->

# Risk Assessment

## Risk Form {#risk}
```{r formpath}
# provide the path to the filled out risk form (will be embedded)
formPath <- "./RiskAssessment_internal.docx"
```

<!-- Do NOT modify this section. -->
The risk level is **`r toupper(strsplit(basename(formPath), "-")[[1]][[1]])`**.
The filled out form can be found here:

```{r form, echo=FALSE}
if (file.exists(formPath)) {
  xfun::embed_file(formPath)
} else {
  incompleteFun("Risk form not found.")
}
```
<!-- --------------------------- -->

## Functional Risk Assessment
The functional risk assessment (FRA) provides a systematic and pragmatic approach to study the risk
associated with a package, helping to direct efforts towards potentially problematic aspects.

<!-- $ Please fill out the following for HIGH risk packages ONLY. Otherwise type "N/A". 
Example (see https://esops.d4n.eu.novartis.net/DMSDocFinder/open/FRM-8127440_EF.pdf section 3.1.3 for more details)

```{r, fra, echo=FALSE}
#fra <- tibble::tribble(
#~ID,      ~Process Description, ~Hazard,                    ~Harm,                                         ~Severity, ~Probability, #~Detectability, ~Risk Class, ~Risk Priority
#"Risk-1", "DLT computation"   , "Incorrect value computed", "Trial statistician makes wrong assumptions.", "MEDIUM",  "MEDIUM",
#"MEDIUM",       2,           "MEDIUM",
#)

#knitr::kable(fra)
```
-->

# Test Strategy Plan {#testStrategy}
The test strategy plan outlines the key focus areas for the testing in light of 
the [foreseen use cases](#description), stated [requirements](#requirements) and identified [risks](#risk).

<!-- $ Please provide an overview of which function(alitie)s of the package will be tested and how, 
referencing requirement or risk IDs where applicable. 

Example:
Functions X and Y (and associated low-level functions) pertaining to requirements A and B, respectively, are covered by simple unit tests that ensure the acceptance of valid inputs (positive testing) and rejection of invalid inputs (negative testing), commensurate with the identified LOW risk priority. Function Z, which is associated with HIGH risk priority, is further covered by multiple computationally intensive tests that compare the computed outputs to benchmark cases, confirming their correctness. These tests, which require access to a high-performance computing cluster, is performed separately and the results are provided in this report [below](#extraTests).
...

-->

# Code Review

<!-- $ Please provide an overview of performed code review activities. Name reviewers, their qualifications, and what they reviewed. 
Provide links to merge requests or similar where appropriate. Code reviews should have been performed _for the version of the package in question_. State clearly when a review was performed for a different version and outline why this is acceptable.

Example (use a format of your choice: bullet lists, tables, subsections...):
- Reviewer alpha has a PhD in biostatistics and is a trial statistician; they performed code review of functions X and Y pertaining to the statistical methodology used (cf. merge request [!123](link-to-merge-request))
- Reviewer beta has a computer science degree and reviewed the numerical implementation of the algorithm in function Z.
...
-->

# Test Summary Report

The test summary report outlines the testing results obtained given the stated [test strategy plan](#testStrategy).

## `R CMD check` output

Packages must provide evidence of a successful `R CMD check`.

```{r checkPath}
# provide the path to the <PACKAGE>.Rcheck folder, which is the output of
# R CMD check

checkPath <- '.'
```

<!-- Do NOT modify this section. -->
```{r check}
if (!is.null(checkPath)) {
  # zip the files
  utils::zip(paste0(PACKAGE, "-checkResults.zip"), checkPath)
} else {
  incompleteFun("No `R CMD check` output available.")
}

errors <- system(sprtinf("grep --include 00check.log -rnwP 'Status: \\d ERROR' %s", checkPath), intern=T)

if (length(errors) > 0) {
  incompleteFun("The check log contains at least one ERROR.")
}

xfun::embed_file(paste0(PACKAGE, "-checkResults.zip"))
```
<!-- --------------------------- -->

## Coverage report

```{r coveragePath}
# either provide the path to the package source so that coverage can be calculated
# or provide the path to a report (set the other one NULL)

pkgPath <- '.' # the path to the repo files
reportPath <- '.'
```

<!-- Do NOT modify this section. -->
```{r coverage}
if (!is.null(pkgPath)) {
  pkgCov <- covr::package_coverage(pkgPath)
  
  coverage <- round(covr::percent_coverage(pkgCov)) # 79.5% counts as sufficient

  reportPath <- file.path(tempdir(), paste0(PACKAGE, "-report.html"))
  covr::report(pkgCov, file=reportPath, browse = FALSE)
} else {
  myReport <- readLines(reportPath)
  coverage <- myReport[grep(".*coverage - \\d{1,3}[.]\\d{0,2}%.*", l)]
  
  coverage <- round(as.numeric(gsub(".* (\\d{1,3}[.]\\d{0,2}).*", "\\1", coverage )))
}

if (coverage < 80) {
  incompleteFun(sprintf("Coverage is less than 80%% (specifically, it is %.0f%%)",
                      coverage))
}

xfun::embed_file(reportPath)
```
<!-- --------------------------- -->

## Additional test evidence {#extraTests}
<!-- $ Please fill out the following section if there is additional test evidence. Otherwise type "N/A". -->

# Conclusion

<!-- Do NOT modify this section. -->
This document has outlined the requirements and risk associated with internally-developed package {`r PACKAGE`}, together with the testing strategy and results. 
The obtained results indicate the package satisfies the acceptance criteria for such packages as governed by [WP-8125598](https://esops.d4n.eu.novartis.net/DMSDocFinder/open/WP-8125598_EF.pdf) and the [SOS Management Team](http://go/davinci/sos).
<!-- --------------------------- -->

## Session Information
```{r sessioninfo, echo=TRUE}
sessionInfo()
```
